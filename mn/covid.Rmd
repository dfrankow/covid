---
title: "Minnesota Covid 19 data"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

# Introduction

What is the trend in Covid-19 cases in Minnesota?

# `r format(Sys.time(), '%B %e, %Y')`

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(scales)

knitr::opts_chunk$set(
  # Don't put code in the doc
  echo = FALSE,
  # Don't put messages from code in the doc
  message = FALSE,
  # Don't put code warnings in the doc
  warning = FALSE,
  # stop on error instead of continuing
  error = FALSE,
  # Don't let figures float
  # Needs "float" package, see https://stackoverflow.com/a/36234023/34935
  fig.pos = "H",
  # Default height 3.75 inches: two per page plus text
  fig.height = 3.75
)

theme_set(theme_bw() +
            theme(plot.title=element_text(size=25),
                  panel.grid = element_line(colour="grey85")))
```

```{r funcs}
add_rolling_num <- function(df, col, window_days) {
  c_col <- paste0('c_', col)
  df[[c_col]][!is.na(df[[col]])] <- cumsum(df[[col]][!is.na(df[[col]])])
  col1 <- paste0(col, window_days)
  df[[col1]] <- (df[[c_col]] - lag(df[[c_col]], window_days)) / window_days
  df
}

# add_rolling_rate <- function(df, rate, numer, denom, window_days) {
#   df <- add_rolling_num(df, numer, window_days)
#   df <- add_rolling_num(df, denom, window_days)
#   c_numer <- paste0('c_', numer)
#   c_denom <- paste0('c_', denom)
#   df[[rate]] <- (df[[c_numer]] - lag(df[[c_numer]], window_days)) /
#     (df[[c_denom]] - lag(df[[c_denom]], window_days))
#   df
# }

change_in_percent <- function(vec, window_days, round_n=0) {
  stopifnot(length(vec) >= window_days)
  last <- tail(vec, 1)
  last_minus <- head(tail(vec, window_days+1), 1)
  delta <- (last - last_minus)
  fmt <- paste0("%+.", round_n, "f (%+.", round_n, "f%%)")
  sprintf(fmt, delta, 100* delta / last_minus, 1)
}

CHANGE_WINDOW <- 14
```

```{r graphs, fig.show = "hold", out.width = "50%"}
########## hospitalized

hospdata <- read_tsv('data/hosptable.tsv')
names(hospdata) <- c('date', 'icu_admits', 'all_admits',
                    'total_hosp', 'total_icu_hosp')
hospdata <- hospdata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
  # july 4 had "-" in the data
  icu_admits = as.numeric(icu_admits),
  all_admits = as.numeric(all_admits)
)

# Weird data on Oct 3, 2020, where Oct 2 and 3 had a bunch of zeros
# last_day <- hospdata %>% filter(all_admits > 0) %>% pull(date) %>% max(na.rm=T)
last_day <- max(hospdata$date, na.rm=T)

# last 4 weeks
# first_day <- last_day - 28*1
# last 8 weeks
# first_day <- last_day - 28*2
# last 12 weeks
# first_day <- last_day - 28*3
# last 16 weeks
# first_day <- last_day - 28*4
# last 365 days
 first_day <- last_day - 365

# hospdata <- hospdata %>% filter(date <= last_day)

# Controls the amount of smoothing for the default loess smoother.
# Smaller numbers produce wigglier lines, larger numbers produce smoother lines.
# default: 0.75
loess_span <- 0.5

hospdata <- add_rolling_num(hospdata, 'icu_admits', 7)
hospdata <- add_rolling_num(hospdata, 'all_admits', 7)

hospdataf1 <- head(hospdata,-7)

# change in icu_admits7 over last 7 days
icu_admits7_delta7_percent <- change_in_percent(hospdataf1$icu_admits7, CHANGE_WINDOW)

# change in all_admits7 over last 7 days
all_admits7_delta7_percent <- change_in_percent(hospdataf1$all_admits7, CHANGE_WINDOW)

hospdata_long <- hospdata %>%
  pivot_longer(c('icu_admits', 'icu_admits7', 'all_admits', 'all_admits7')) %>%
  filter(date >= first_day) %>%
  mutate(color = ifelse(name %in% c('icu_admits', 'icu_admits7'), 'icu_admits', 'all_admits'),
         size = ifelse(name %in% c('icu_admits', 'all_admits'), 0.25, 1)) %>%
  filter(!(name %in% c('icu_admits7', 'all_admits7') & (date > max(hospdataf1$date, na.rm=T))))

ggplot(hospdata_long %>% filter(name %in% c('icu_admits', 'all_admits')),
       aes(date, value, group=name, color=color)) +
  geom_point(alpha=0.25) +
  geom_line(data=hospdata_long %>% filter(name %in% c('icu_admits7', 'all_admits7')),
            aes(size=size, alpha=size)) +
  geom_line(data=hospdata_long %>% filter(name %in% c('icu_admits', 'all_admits')),
            aes(size=size, alpha=size)) +
  labs(title="Hospital admissions",
       subtitle=paste0(
                "icu admits average ", round(tail(hospdata$icu_admits7, 1)),
                ", 14-day change ", icu_admits7_delta7_percent,
                "\nall admits average ",
                round(tail(hospdata$all_admits7, 1)),
                ", 14-day change ", all_admits7_delta7_percent, "\n",
                "Last 7 days may have incomplete data."),
       y="admitted on a given date.") +
  scale_y_continuous(limits=c(0,NA)) +
  scale_size_identity() +
  scale_alpha_identity() +
  scale_x_date(date_minor_breaks="1 month")

rm(hospdata)
rm(hospdata_long)

########## deaths

deathdata <- read_tsv('data/deathtable.tsv')
names(deathdata) <- c('date', 'daily_deaths', 'cumulative_deaths')
deathdata <- deathdata %>%
  mutate(
    date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
    # july 4 had "-" in the data
    daily_deaths = as.numeric(daily_deaths)
  ) %>%
  add_rolling_num('daily_deaths', 7)

ggplot(deathdata %>% filter(date >= first_day),
       aes(date, daily_deaths)) +
  geom_point(aes(y=daily_deaths), alpha=0.25) +
  geom_line(aes(y=daily_deaths7), size=1) +
  geom_line(aes(y=daily_deaths), alpha=0.25) +
  labs(title="Daily deaths",
       subtitle=paste0(
         "average ", round(tail(deathdata$daily_deaths7, 1)),
         ", 14-day change ",
         change_in_percent(deathdata$daily_deaths7, CHANGE_WINDOW))) +
  scale_y_continuous(limits=c(0,NA)) +
  scale_alpha_identity() +
  scale_x_date(date_minor_breaks="1 month")

########## confirmed cases - last 7 days may be incomplete

casedata <- read_tsv('data/casetable.tsv')
names(casedata) <- c('date', 'daily_cases', 'cumulative_cases')
casedata <- casedata %>%
  mutate(
    date = as.Date(paste0("2020/", date), format="%Y/%m/%d")
  ) %>%
  add_rolling_num('daily_cases', 7)

# make alpha of last 7 days less
the_alpha <- 0.1
casedata$alpha <- c(rep(0.25, nrow(casedata)-7), rep(the_alpha, 7))
casedataf <- casedata %>% filter(date >= first_day)
casedataf1 <- head(casedataf,-7)
ggplot(casedataf,
       aes(date, daily_cases)) +
  geom_point(aes(alpha=alpha)) +
  geom_line(aes(alpha=alpha)) +
  geom_line(data=casedataf1, aes(y=daily_cases7), size=1) +
  labs(title="Daily confirmed cases",
       subtitle=paste0(
         "average ", round(tail(casedataf1$daily_cases7, 1)),
         ", 14-day change ",
         change_in_percent(casedataf1$daily_cases7, CHANGE_WINDOW), ".",
         "  Last 7 days may have incomplete data.")) +
  scale_y_continuous(limits=c(0,NA)) +
  scale_alpha_identity() +
  scale_x_date(date_minor_breaks="1 month")


########## tests - last 7 days may be incomplete

labdata <- read_tsv('data/labtable.tsv')
names(labdata) <- c('date', 'mn_lab_tests', 'ext_lab_tests',
                    'total_cumulative_tests')
labdata <- labdata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
  # commas throw things off
  mn_lab_tests = as.integer(gsub(",", "", mn_lab_tests)),
  ext_lab_tests = as.integer(gsub(",", "", ext_lab_tests)),
  daily_tests = mn_lab_tests + ext_lab_tests
) %>%
  add_rolling_num('daily_tests', 7)


# make alpha of last 7 days less
labdata$alpha <- c(rep(0.25, nrow(labdata)-7), rep(the_alpha, 7))
labdataf <- labdata %>% filter(date >= first_day)
labdataf1 <- head(labdataf, -7)
ggplot(labdataf, aes(date, daily_tests)) +
  geom_point(aes(alpha=alpha)) +
  geom_line(data=labdataf, aes(alpha=alpha)) +
  geom_line(data=labdataf1, aes(y=daily_tests7), size=1) +
  labs(title="Daily tests",
       subtitle=paste0(
         "average ", round(tail(labdataf1$daily_tests7, 1)),
         ", 14-day change ",
         change_in_percent(labdataf1$daily_tests7, CHANGE_WINDOW), ".",
         "  Last 7 days may have incomplete data.")) +
  scale_y_continuous(limits=c(0,NA)) +
  scale_alpha_identity() +
  scale_x_date(date_minor_breaks="1 month")

############ positive test rate
caselabdata <- casedata %>% inner_join(labdata, by=c('date')) %>%
  mutate(positive_rate7 = daily_cases7 / daily_tests7)
caselabdata$alpha <- c(rep(1, nrow(caselabdata)-7), rep(0.2, 7))

caselabdataf <- head(caselabdata, -7)

ggplot(caselabdata %>% filter(date >= first_day),
       aes(date, positive_rate7)) +
  geom_point(aes(alpha=alpha)) +
  geom_line(aes(alpha=alpha)) +
  labs(title="Positive test rate (unofficial)",
       subtitle=paste0(
         "average ", round(tail(100*caselabdataf$positive_rate7, 1), 1),
         "%, 14-day change ",
         change_in_percent(100*caselabdataf$positive_rate7, CHANGE_WINDOW, 1), ".",
         "  Last 7 days may have incomplete data."),
       y="confirmed cases / tests (rolling 7 days)") +
  scale_y_continuous(limits=c(0,NA), labels=percent) +
  scale_alpha_identity() +
  geom_hline(yintercept=0.05, linetype='dashed') +
  scale_x_date(date_minor_breaks="1 month")
```

Data from https://www.health.state.mn.us/diseases/coronavirus/situation.html.

The graphs are over the last 8 weeks (56 days), to let us see more recent trends.

The trend lines end early for data that may be incomplete.

The grey area is a smoothed line with confidence bands.
Technically, it's default geom_smooth, which in this case is loess (local estimation).
Roughly, it fits a low-degree polynomial to data points near each point.
The grey shaded area is a 95% confidence interval, which roughly means there's
a 95% chance the true mean is in the band.
It sounds fancy, but I just use the default settings for the tool (ggplot),
and it looks plausible.
