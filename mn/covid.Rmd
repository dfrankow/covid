---
title: "Minnesota Covid 19 data"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

# Introduction

What is the trend in Covid-19 cases in Minnesota?

# `r format(Sys.time(), '%B %e, %Y')`

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(scales)

knitr::opts_chunk$set(
  # Don't put code in the doc
  echo = FALSE,
  # Don't put messages from code in the doc
  message = FALSE,
  # Don't put code warnings in the doc
  warning = FALSE,
  # stop on error instead of continuing
  error = FALSE,
  # Don't let figures float
  # Needs "float" package, see https://stackoverflow.com/a/36234023/34935
  fig.pos = "H",
  # Default height 3.75 inches: two per page plus text
  fig.height = 3.75
)

theme_set(theme_bw() +
            theme(plot.title=element_text(size=25)))
```

```{r graphs, fig.show = "hold", out.width = "50%"}
########## hospitalized

hospdata <- read_tsv('data/hosptable.tsv')
names(hospdata) <- c('date', 'icu', 'non_icu',
                    'total_hosp', 'total_icu_hosp')
hospdata <- hospdata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
  # july 4 had "-" in the data
  icu = as.numeric(icu),
  non_icu = as.numeric(non_icu)
)

# last 4 weeks
# first_day <- max(hospdata$date) - 28*1
# last 8 weeks
# first_day <- max(hospdata$date) - 28*2
# last 12 weeks
first_day <- max(hospdata$date) - 28*3
# last 365 days
# first_day <- max(hospdata$date) - 365

# Controls the amount of smoothing for the default loess smoother.
# Smaller numbers produce wigglier lines, larger numbers produce smoother lines.
# default: 0.75
loess_span <- 0.5

hospdata_long <- hospdata %>%
  pivot_longer(c('icu', 'non_icu'))
ggplot(hospdata_long %>% filter(date >= first_day),
       aes(date, value, group=name, color=name)) +
  geom_point() + geom_line() +
  geom_smooth(span=loess_span) +
  labs(title="Hospitalized",
       subtitle="as of the given date",
       y="hospitalized as of given date") +
  scale_y_continuous(limits=c(0,NA))

########## deaths

deathdata <- read_tsv('data/deathtable.tsv')
names(deathdata) <- c('date', 'daily_deaths', 'cumulative_deaths')
deathdata <- deathdata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
  # july 4 had "-" in the data
  daily_deaths = as.numeric(daily_deaths)
)
ggplot(deathdata %>% filter(date >= first_day),
       aes(date, daily_deaths)) + geom_point() + geom_line() +
  geom_smooth(span=loess_span) +
  labs(title="Deaths") +
  scale_y_continuous(limits=c(0,NA))

########## confirmed cases - last 7 days may be incomplete

casedata <- read_tsv('data/casetable.tsv')
names(casedata) <- c('date', 'daily_cases', 'cumulative_cases')
casedata <- casedata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
)
# make alpha of last 7 days less
the_alpha <- 0.3
casedata$alpha <- c(rep(1, nrow(casedata)-7), rep(the_alpha, 7))
casedataf <- casedata %>% filter(date >= first_day)
ggplot(casedataf,
       aes(date, daily_cases)) +
  geom_point(aes(alpha=alpha)) + geom_line(aes(alpha=alpha)) +
  geom_smooth(data=head(casedataf,-7), span=loess_span) +
  labs(title="Confirmed cases",
       subtitle="Last 7 days may have incomplete data") +
  scale_y_continuous(limits=c(0,NA)) +
  scale_alpha_identity()


########## tests - last 7 days may be incomplete

labdata <- read_tsv('data/labtable.tsv')
names(labdata) <- c('date', 'mn_lab_tests', 'ext_lab_tests',
                    'total_cumulative_tests')
labdata <- labdata %>% mutate(
  date = as.Date(paste0("2020/", date), format="%Y/%m/%d"),
  # commas throw things off
  mn_lab_tests = as.integer(gsub(",", "", mn_lab_tests)),
  ext_lab_tests = as.integer(gsub(",", "", ext_lab_tests)),
  daily_tests = mn_lab_tests + ext_lab_tests
)
# make alpha of last 7 days less
labdata$alpha <- c(rep(1, nrow(labdata)-7), rep(the_alpha, 7))
labdataf <- labdata %>% filter(date >= first_day)
ggplot(labdataf, aes(date, daily_tests)) +
  geom_point(aes(alpha=alpha)) + geom_line(aes(alpha=alpha)) +
  geom_smooth(data=head(labdataf,-7), span=loess_span) +
  labs(title="Tests",
       subtitle="Last 7 days may have incomplete data") +
  scale_y_continuous(limits=c(0,NA)) +
  scale_alpha_identity()

############ positive test rate
caselabdata <- casedata %>% inner_join(labdata, by=c('date')) %>%
  mutate(
    positive_rate_daily = daily_cases / daily_tests,
    c_daily_cases = cumsum(daily_cases),
    c_daily_tests = cumsum(daily_tests),
    daily_cases14 = c_daily_cases - lag(c_daily_cases, 14),
    daily_tests14 = c_daily_tests - lag(c_daily_tests, 14),
    positive_rate_14 = daily_cases14 / daily_tests14,
    daily_cases7 = c_daily_cases - lag(c_daily_cases, 7),
    daily_tests7 = c_daily_tests - lag(c_daily_tests, 7),
    positive_rate_7 = daily_cases7 / daily_tests7)

# For more discussion about this graph, see
# https://www.reddit.com/r/CoronavirusMN/comments/ictujj/aug_19_mn_trend_update/g27gz3v?utm_source=share&utm_medium=web2x&context=3
# ggplot(caselabdata, aes(date, positive_rate_daily)) +
#   geom_point(aes(alpha=alpha.x)) + geom_line(aes(alpha=alpha.x)) +
#   geom_smooth(data=head(caselabdata,-7), span=loess_span) +
#   labs(title="Positive test rate (daily)",
#        subtitle="Last 7 days may have incomplete data",
#        y="confirmed cases / tests") +
#   scale_y_continuous(limits=c(0,NA), labels=percent) +
#   scale_alpha_identity() +
#   geom_hline(yintercept=0.05, linetype='dashed')

# might be able to put a grey rectangle with this, eventually:
# https://stackoverflow.com/a/9969983/34935
#+
#  geom_rect(data.frame(xstart = c(max(caselabdata$date)-7)),
#                       xend = c(max(caselabdata$date)),
#            aes(xmin = xstart, xmax = xend, ymin = -Inf, ymax = Inf), alpha = 0.4)

ggplot(caselabdata %>% filter(date >= first_day),
       aes(date, positive_rate_7)) +
  geom_point(aes(alpha=alpha.x)) + geom_line(aes(alpha=alpha.x)) +
  labs(title="Positive test rate (unofficial)",
       subtitle="Last 7 days may have incomplete data",
       y="confirmed cases / tests (rolling 7 days)") +
  scale_y_continuous(limits=c(0,NA), labels=percent) +
  scale_alpha_identity() +
  geom_hline(yintercept=0.05, linetype='dashed')
```

Data from https://www.health.state.mn.us/diseases/coronavirus/situation.html.

The graphs are over the last 8 weeks (56 days), to let us see more recent trends.

The trend lines end early for data that may be incomplete.

The grey area is a smoothed line with confidence bands.
Technically, it's default geom_smooth, which in this case is loess (local estimation).
Roughly, it fits a low-degree polynomial to data points near each point.
The grey shaded area is a 95% confidence interval, which roughly means there's
a 95% chance the true mean is in the band.
It sounds fancy, but I just use the default settings for the tool (ggplot),
and it looks plausible.
